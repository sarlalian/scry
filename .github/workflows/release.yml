name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            target: linux-x64
            bun-target: bun-linux-x64
            artifact-name: scry-linux-x64
          - os: ubuntu-latest
            target: linux-arm64
            bun-target: bun-linux-aarch64
            artifact-name: scry-linux-arm64

          # macOS builds
          - os: macos-latest
            target: darwin-x64
            bun-target: bun-darwin-x64
            artifact-name: scry-darwin-x64
          - os: macos-latest
            target: darwin-arm64
            bun-target: bun-darwin-aarch64
            artifact-name: scry-darwin-arm64

          # Windows build
          - os: windows-latest
            target: windows-x64
            bun-target: bun-windows-x64
            artifact-name: scry-windows-x64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run type check
        run: bun run typecheck

      - name: Run lint
        run: bun run lint

      - name: Run tests
        run: bun test

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build binary (Unix)
        if: runner.os != 'Windows'
        run: |
          bun build --compile --target=${{ matrix.bun-target }} --outfile dist/${{ matrix.artifact-name }} src/index.ts

      - name: Build binary (Windows)
        if: runner.os == 'Windows'
        run: |
          bun build --compile --target=${{ matrix.bun-target }} --outfile dist/${{ matrix.artifact-name }} src/index.ts

      - name: Generate binary checksum (Unix)
        if: runner.os != 'Windows'
        working-directory: dist
        run: |
          shasum -a 256 ${{ matrix.artifact-name }} > ${{ matrix.artifact-name }}.sha256

      - name: Generate binary checksum (Windows)
        if: runner.os == 'Windows'
        working-directory: dist
        shell: pwsh
        run: |
          $hash = (Get-FileHash -Algorithm SHA256 ${{ matrix.artifact-name }}).Hash.ToLower()
          "$hash  ${{ matrix.artifact-name }}" | Out-File -Encoding ASCII ${{ matrix.artifact-name }}.sha256

      - name: Verify binary (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x dist/${{ matrix.artifact-name }}
          dist/${{ matrix.artifact-name }} --version || echo "Binary built successfully"

      - name: Rename binary with version
        shell: bash
        working-directory: dist
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ "$RUNNER_OS" = "Windows" ]; then
            mv ${{ matrix.artifact-name }} scry-${VERSION}-${{ matrix.target }}.exe
            mv ${{ matrix.artifact-name }}.sha256 scry-${VERSION}-${{ matrix.target }}.exe.sha256
          else
            mv ${{ matrix.artifact-name }} scry-${VERSION}-${{ matrix.target }}
            mv ${{ matrix.artifact-name }}.sha256 scry-${VERSION}-${{ matrix.target }}.sha256
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}-${{ steps.version.outputs.version }}
          path: |
            dist/scry-*
          retention-days: 5

  create-release:
    needs: build-and-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          ls -lah release-artifacts/

      - name: Generate combined checksums file
        working-directory: release-artifacts
        run: |
          cat *.sha256 > checksums.txt
          cat checksums.txt

      - name: Extract release notes
        id: release_notes
        run: |
          # Try to get the tag annotation message
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${GITHUB_REF#refs/tags/})

          if [ -n "$TAG_MESSAGE" ]; then
            echo "Using tag annotation message"
            echo "$TAG_MESSAGE" > release_notes.md
          elif [ -f "CHANGELOG.md" ]; then
            echo "Extracting from CHANGELOG.md"
            # Extract the section for this version
            sed -n "/^## \[*${{ steps.version.outputs.version }}\]/,/^## \[/p" CHANGELOG.md | sed '$ d' > release_notes.md
          else
            echo "No release notes found, generating default"
            cat > release_notes.md << EOF
          ## What's Changed

          Release ${{ steps.version.outputs.version }}

          ### Installation

          Download the appropriate binary for your platform:
          - **Linux x64**: scry-${{ steps.version.outputs.version }}-linux-x64
          - **Linux ARM64**: scry-${{ steps.version.outputs.version }}-linux-arm64
          - **macOS x64**: scry-${{ steps.version.outputs.version }}-darwin-x64
          - **macOS ARM64** (Apple Silicon): scry-${{ steps.version.outputs.version }}-darwin-arm64
          - **Windows x64**: scry-${{ steps.version.outputs.version }}-windows-x64.exe

          Make the binary executable (Unix/macOS):
          \`\`\`bash
          chmod +x scry-${{ steps.version.outputs.version }}-<platform>-<arch>
          \`\`\`

          Verify the download (optional):
          \`\`\`bash
          sha256sum -c checksums.txt
          \`\`\`

          ### Full Changelog
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.version.outputs.version }}...HEAD
          EOF
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            release-artifacts/scry-*
            release-artifacts/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "### Release v${{ steps.version.outputs.version }} created successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Artifacts:" >> $GITHUB_STEP_SUMMARY
          cd release-artifacts
          for file in scry-*; do
            if [[ ! $file == *.sha256 && ! $file == checksums.txt ]]; then
              SIZE=$(du -h "$file" | cut -f1)
              echo "- \`$file\` ($SIZE)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the release at: https://github.com/${{ github.repository }}/releases/tag/${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY

  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "### Docker Image Published :whale:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image: \`ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  npm-publish:
    runs-on: ubuntu-latest
    needs: build-and-release
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Publish to npm with provenance
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        run: |
          echo "### npm Package Published :package:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Package: \`@sarlalian/scry@${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "bun install -g @sarlalian/scry" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
